# Mosaic - Development Dockerfile
# For local development and testing outside of HA

FROM golang:1.22-alpine AS builder

# Pixlet requires these native dependencies
RUN apk add --no-cache \
    git \
    build-base \
    libwebp-dev \
    libwebp-tools \
    pango-dev \
    cairo-dev \
    pkgconf

WORKDIR /build

# Copy everything needed for the build
COPY go.mod go.sum ./
COPY cmd/ ./cmd/
COPY internal/ ./internal/

# Resolve dependencies (go.sum may be incomplete)
RUN go mod tidy

# Build the binary with CGO enabled (required for Pixlet)
RUN go build -o mosaic ./cmd/mosaic

# Runtime stage
FROM alpine:3.18

# Install runtime dependencies (libwebp-tools includes demux/mux libs)
RUN apk add --no-cache \
    ca-certificates \
    libwebp \
    libwebp-tools \
    pango \
    cairo \
    tzdata

# Create app directories
RUN mkdir -p /app/apps /data

# Copy binary from builder
COPY --from=builder /build/mosaic /usr/bin/mosaic

# Copy web assets
COPY web/ /app/web/

# Copy bundled apps
COPY apps/ /app/apps/

WORKDIR /app

EXPOSE 8075

CMD ["/usr/bin/mosaic"]
